<div class="map-layout">
    <div class="map-leaflet"
        leaflet
        [leafletOptions]="configure.options"
        (leafletMapReady)="initMap($event)">

        <div *ngFor="let marker of markers | keyvalue; trackBy:trackByFn" [leafletLayer]="$any(marker).value"></div>
    </div>

    <div class="map-search">
        <div class="map-search-bar">
            <nz-input-group [nzSuffix]="searchQuery.length > 0 ? suffixIconClose : suffixIconSearch" [nzSize]="'large'">
                <input type="text" nz-input placeholder="Tìm vị trí" [(ngModel)]="searchQuery" appSearchRoads [appSearchRoadsText]="searchQuery" (newListRoads)="searchResults = $event" (isSearch)="isSearch = $event"/>
            </nz-input-group>
            <ng-template #suffixIconSearch>
            <i nz-icon nzType="search"></i>
            </ng-template>
            <ng-template #suffixIconClose>
                <i nz-icon nzType="close" (click)="searchIconClick()"></i>
            </ng-template>
    
            <div class="results transition visible" *ngIf="searchResults?.length > 0 && isSearch">
                <ul nz-menu>
                    <li class="map-search-result" nz-menu-item *ngFor="let result of searchResults; index as i" (click)="searchSelect(result)">
                        <b>{{result.properties.name}}</b>
                        <br>
                        {{result.properties.city}}
                    </li>
                </ul>
            </div>
            <div class="results transition visible" *ngIf="searchResults?.length <= 0 && isSearch" style="background-color: white;">
                <ul nz-menu>
                    <li class="map-search-result" nz-menu-item>
                        <b>Không tìm thấy</b>
                        <br>
                        Hãy thử lại
                    </li>
                </ul>
            </div>
        </div>
    </div>


    
    <button class="map-layout-info-button" nz-button nzType="primary" [@mapLayoutInfoButton]="{value: isOpen ? 'open' : 'closed', params: {curWidth: curWidth >= 992 ? '33%':'340px'}}" (click)="toggleLayout()">
        <i nz-icon nzType="{{isOpen ? 'left' : 'right'}}"></i>
    </button>

<<<<<<< HEAD
    <div [@mapLayoutInfo]="{value: isOpen ? 'open' : 'closed', params: {curWidth: curWidth >= 992 ? '-33%':'-340px'}}" class="map-layout-info">
        <router-outlet *ngIf="this.sideMap"></router-outlet>
=======
    <div [@mapLayoutInfo]="isOpen ? 'open' : 'closed'" class="map-layout-info" *ngIf="currentMode">
        <div class="map-layout-info-header"></div>
        <div>
            <nz-divider [nzText]="dividerText" class="divider-blue"></nz-divider>
        </div>
        <div class="map-layout-info-content">
            <div *ngIf="currentMode == 'cameras'">
                <nz-card [nzCover]="cameraCover">
                    <img *ngIf="chosenMarkers['camera']" class="angle-camera" src="assets/images/compass.png" [ngStyle]="chosenMarkers['camera']?.angleStyle">
                    <div id="crEventCamera" class="camera-create-event-icon" (click)="createdEventByCamera(chosenMarkers['camera'])" title="Tạo cảnh báo ở camera này"><i class="fa-solid fa-triangle-exclamation"></i></div>
                
                    <div *ngIf="chosenMarkers['camera']" >
                        <nz-card-meta [nzTitle]="'Tên camera: '+chosenMarkers['camera'].name" [nzDescription]="chosenMarkers['camera'].lastUpdated | amLocale:'vi' | amTimeAgo"></nz-card-meta>
                        <br>
                        <nz-row>
                            <nz-col nzFlex="1">
                                <button nz-button nzBlock="true" (click)="share('camera', chosenMarkers['camera']._id)">
                                    <i class="fa-solid fa-share-from-square"></i>
                                    <span class="map-layout-info-content-button">Chia sẻ</span>
                                </button>
                            </nz-col>
                            <nz-col nzFlex="1">
                                <button nz-button nzBlock="true" (click)="favoriteCamera(chosenMarkers['camera'])">
                                    <i class="fa-solid fa-star" [ngClass]="{'yellow': checkExistInFavoriteList(chosenMarkers['camera']._id)}"></i>
                                    <span class="map-layout-info-content-button" [ngClass]="{'yellow': checkExistInFavoriteList(chosenMarkers['camera']._id)}">Quan tâm</span>
                                  </button>
                            </nz-col>
                        </nz-row>              
                    </div>
                </nz-card>
    
                <ng-template #cameraCover>
                    <img class="map-camera-image" *ngIf="!chosenMarkers['camera']" src="//dummyimage.com/600x400/000/fff&text=Vui lòng chọn camera">
                    <img class="map-camera-image" *ngIf="chosenMarkers['camera'] && chosenMarkers['camera']?.liveviewUrl" (error)="imageError($event)" src="{{chosenMarkers['camera'].url}}" (load)="cameraLoading = false">
                    <img class="map-camera-image" *ngIf="chosenMarkers['camera'] && !chosenMarkers['camera']?.liveviewUrl || chosenMarkers['camera']?.liveview === ''" src="//dummyimage.com/600x400/000/fff&text=Camera sai thông số" (load)="cameraLoading = false">
                </ng-template>
                <nz-divider nzText="Quan tâm" class="divider-blue"></nz-divider>

                <div *ngIf="listFavoriteCamera.length <= 0">
                    <nz-card>
                        <nz-card-meta nzTitle="Bạn chưa quan tâm camera nào"></nz-card-meta> 
                    </nz-card>
                    <br>
                </div>
                
                <div *ngIf="listFavoriteCamera.length > 0">
                    <div *ngFor="let favCamera of listFavoriteCamera" (click)="chooseCameraFromList(favCamera.fId)">
                        <nz-card [nzCover]="cameraCoverFavorite">
                            <nz-card-meta [nzTitle]="'Tên camera: '+favCamera.fName"></nz-card-meta> 
                        </nz-card>
    
                        <ng-template #cameraCoverFavorite>
                            <!-- <img class="map-camera-image" (error)="imageError($event)" src="{{backend}}api/snapshot/{{favCamera.fId}}" (load)="cameraLoading = false"> -->
                        </ng-template>
                        <br>
                    </div>
                </div>
            </div>

            <div *ngIf="currentMode == 'parkings'">

                <nz-card>              
                    <div *ngIf="chosenMarkers['parking']" >
                        <nz-row class="parking-header">
                            <h3>{{chosenMarkers['parking'].name}}</h3>
                        </nz-row>
                        <nz-row class="mt-3">
                            <div class="ui blue labels" *ngIf="chosenMarkers['parking']['vehicle_type']['car'] || chosenMarkers['parking']['vehicle_type']['bike']">
                                <div class="ui label" *ngIf="chosenMarkers['parking']['vehicle_type']['car']"> Ô tô </div>
                                <div class="ui label" *ngIf="chosenMarkers['parking']['vehicle_type']['bike']"> Xe máy </div>
                            </div>

                            
                        </nz-row>
                        <nz-row  *ngIf="chosenMarkers['parking']?.worktime">
                            <p><b>Địa chỉ: </b> {{chosenMarkers['parking']?.addr}}</p>
                        </nz-row>
                        <nz-row  *ngIf="chosenMarkers['parking']?.worktime">
                            <p><b>Thời gian làm việc: </b> Từ {{chosenMarkers['parking'].worktime['startWorking']}} đến {{chosenMarkers['parking'].worktime['endWorking']}} giờ</p>
                        </nz-row>
                        <nz-row  *ngIf="chosenMarkers['parking']?.worktime_details">
                            <p><b>Ngày làm việc: </b> {{chosenMarkers['parking'].worktime_details}}</p>
                        </nz-row>
                        <nz-row class="mt-3">
                            <nz-col nzFlex="1">
                                <button nz-button nzBlock="true" (click)="share('parking', chosenMarkers['parking']?._id)">
                                    <i class="fa-solid fa-share-from-square"></i>
                                    <span class="map-layout-info-content-button">Chia sẻ</span>
                                </button>
                            </nz-col>

                            <nz-col nzFlex="1">
                                <button nz-button nzBlock="true" (click)="favoriteParking(chosenMarkers['parking'])">
                                    <i class="fa-solid fa-star" [ngClass]="{'yellow': checkParkingExistInFavoriteList(chosenMarkers['parking']._id)}"></i>
                                    <span class="map-layout-info-content-button" [ngClass]="{'yellow': checkParkingExistInFavoriteList(chosenMarkers['parking']._id)}">Quan tâm</span>
                                  </button>
                            </nz-col>
                        </nz-row>              
                    </div>

                    <div *ngIf="!chosenMarkers['parking']" >
                        <nz-row>
                            <h3>Vui lòng chọn bãi đỗ xe</h3>
                        </nz-row>       
                    </div>
                </nz-card>

                <nz-divider nzText="Quan tâm" class="divider-blue"></nz-divider>

                <div *ngIf="getParkingFromFavorList().length <= 0">
                    <nz-card>
                        <nz-card-meta nzTitle="Bạn chưa quan tâm bãi xe nào"></nz-card-meta> 
                    </nz-card>
                    <br>
                </div>
                
                <div *ngIf="getParkingFromFavorList().length > 0">
                    <div class="mb-3" *ngFor="let parkingFav of getParkingFromFavorList()" (click)="chooseParkingFromList(parkingFav._id)">
                        <nz-card>              
                            <div>
                                <nz-row class="parking-header">
                                    <h3>{{parkingFav.name}}</h3>
                                </nz-row>
                                <nz-row class="mt-3">
                                    <div class="ui blue labels" *ngIf="parkingFav['vehicle_type']['car'] || parkingFav['vehicle_type']['bike']">
                                        <div class="ui label" *ngIf="parkingFav['vehicle_type']['car']"> Ô tô </div>
                                        <div class="ui label" *ngIf="parkingFav['vehicle_type']['bike']"> Xe máy </div>
                                    </div>
        
                                    
                                </nz-row>
                                <nz-row  *ngIf="parkingFav?.worktime">
                                    <p><b>Địa chỉ: </b> {{parkingFav?.addr}}</p>
                                </nz-row>
                                <nz-row  *ngIf="parkingFav?.worktime">
                                    <p><b>Thời gian làm việc: </b> Từ {{parkingFav.worktime['startWorking']}} đến {{parkingFav.worktime['endWorking']}} giờ</p>
                                </nz-row>
                                <nz-row  *ngIf="parkingFav?.worktime_details">
                                    <p><b>Ngày làm việc: </b> {{parkingFav.worktime_details}}</p>
                                </nz-row>    
                            </div>
                        </nz-card>
                    </div>
                </div>
            </div>

            <div *ngIf="currentMode == 'roadevents'">
                <div class="ui segment">
                    <div class="ui fluid left icon input">
                        <input id="filterRoadEvent" type="text" placeholder="Tìm nhanh" [(ngModel)]="filterRoadEvent" class="form-control">
                            <i class="filter icon "></i>
                    </div>

                    <h4 class="ui center aligned header" *ngIf="listRoadEvents.length <= 0">
                        <div class="content">
                            Không có phân luồng nào
                        </div>
                    </h4>

                    <div class="ui middle aligned selection divided list" *ngIf="listRoadEvents.length > 0">
                        <div class="item" id="{{roadEvent._id}}" *ngFor="let roadEvent of (listRoadEvents | searchFilter: filterRoadEvent: ['geoObject', 'featureCollection', 'properties', 'name'])">
                            <div class="ui toggle checkbox">
                                <input type="checkbox" (click)="toggleRoadEvent(roadEvent)">
                                <label> 
                                    <span class="header">{{roadEvent.geoObject.featureCollection.properties.name}}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="currentMode == 'staticmaps'">
                <div class="ui segment">
                    <div class="ui fluid left icon input">
                        <input id="filterStaticMap" type="text" placeholder="Tìm nhanh" [(ngModel)]="filterStaticMap" class="form-control">
                            <i class="filter icon "></i>
                    </div>
                    <div class="ui middle aligned selection divided list">
                        <div class="item" id="{{staticmap._id}}" *ngFor="let staticmap of (listStaticMaps | searchFilter: filterStaticMap: ['staticMapData', 'name'])">
                            <div class="ui toggle checkbox">
                                <input type="checkbox" (click)="toggleStaticMap(staticmap)">
                                <label> 
                                    <span class="header">{{staticmap.staticMapData.name}}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="currentMode == 'incidents'">
                <div class="ui segment"  *ngIf="listEvent.length <= 0">
                    <h4 class="ui center aligned header">
                        <div class="content">
                            Không có cảnh báo nào
                        </div>
                    </h4>
                </div>


                <div class="ui segment" *ngIf="listEvent.length > 0">
                    <div class="content">
                        <div class="ui large feed">
                            <div id="event-{{event._id}}" class="event" [ngClass]="{'active-event': event._id == chosenMarkers['incident']}" *ngFor="let event of listEvent | orderBy:['createdAt']:['desc']" (click)="chooseIncident(event)">
                                <div class="label event-icon">
                                    <i class="circle icon {{listEventType[event.type].color}}"></i>
                                </div>
                                <div class="content">
                                    <div class="summary">
                                        <a class="user">{{event.desc[0]}}</a>
                                        <div class="date">
                                            <span>{{event.createdAt | amLocale:'vi' | amTimeAgo}}</span>
                                        </div>
                                    </div>
                                    <div class="extra text">
                                        {{event.desc[1]}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- <div class="ui large feed">
                        <div id="event-{{event._id}}" class="event" [ngClass]="{'active-event': event._id == chosenMarkers['incident']}" *ngFor="let event of listEvent | orderBy:['createdAt']:['desc']" (click)="chooseIncident(event)">
                            <div class="label event-icon">
                                <i class="circle icon {{listEventType[event.type].color}}"></i>
                            </div>
                            <div class="content">
                                <div class="summary">
                                    <a class="user">{{event.desc[0]}}</a>
                                    <div class="date">
                                        <span>{{event.createdAt | amLocale:'vi' | amTimeAgo }}</span>
                                    </div>
                                </div>
                                <div class="extra text">
                                    {{event.desc[1]}}
                                </div>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>

            
        </div>
>>>>>>> 99f191d72bee11af400d362e7d17846de28008dc
    </div>
</div>

<nz-modal
      [(nzVisible)]="isShare"
      [nzTitle]="modalTitle"
      [nzContent]="modalContent"
      [nzFooter]="modalFooter"
      (nzOnCancel)="closeModal()">

      <ng-template #modalTitle>Chia sẻ</ng-template>

      <ng-template #modalContent>
        <p nz-typography nzCopyable [nzContent]="shareLink"></p>
      </ng-template>

      <ng-template #modalFooter>
        <button nz-button nzType="primary" (click)="closeModal()">Đóng</button>
      </ng-template>
</nz-modal>
